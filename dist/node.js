"use strict";var y=Object.defineProperty;var p=(o,n)=>y(o,"name",{value:n,configurable:!0});Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});function f({renderToken:o,apiKey:n}){const{env:e="sandbox"}=u(o).payload;async function i({accountId:s,data:a,headers:t}){const c="id"in a.customer?a.customer:await h({requestBody:a.customer,headers:t,apiKey:n,env:e}),r=(await b({requestBody:{...a.paymentIntent,amount:a.paymentIntent?.amount??0,...c?.id&&{customer_id:c.id}},headers:t,apiKey:n,env:e,accountId:s,renderToken:o})).token??"",d=await l({token:r,requestBody:{...a.paymentMethod,...c?.id&&{customer_id:c.id}},headers:t,env:e}),m=u(r).payload.payment_intent_id??"";return await w({token:r,paymentIntentId:m,paymentMethodId:d.id,headers:t,env:e}),await A({token:r,paymentIntentId:m,headers:t,env:e})}return p(i,"createPayment"),{createPayment:i}}p(f,"createClient");async function h({requestBody:o,headers:n,apiKey:e,env:i}){const s=await fetch(`${i==="production"?"https://pay.subfi.com":"https://pay-sandbox.subfi.com"}/customers`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...!n?.Authorization&&{"X-Api-Key":e},...n},body:JSON.stringify({customer:o})});if(s.ok)return s.json();if(s.status===422&&o?.email){const a=await fetch(`${i==="production"?"https://pay.subfi.com":"https://pay-sandbox.subfi.com"}/customers?email=${o.email}`,{headers:{"Content-Type":"application/json",Accept:"application/json",...!n?.Authorization&&{"X-Api-Key":e},...n}});if(a.ok){const t=(await a.json()).data[0];if(o?.metadata&&Object.keys(o.metadata).length>0){const c=await fetch(`${i==="production"?"https://pay.subfi.com":"https://pay-sandbox.subfi.com"}/customers/${t.id}`,{method:"PATCH",headers:{"Content-Type":"application/json",Accept:"application/json",...!n?.Authorization&&{"X-Api-Key":e},...n},body:JSON.stringify({customer:{metadata:{...t.metadata,...o.metadata}}})});if(c.ok)return c.json();throw new Error(c.statusText)}return t}throw new Error(a.statusText)}throw new Error(s.statusText)}p(h,"findOrCreateCustomer");async function b({requestBody:o,headers:n,accountId:e,apiKey:i,renderToken:s,env:a}){const t=await fetch(`${a==="production"?"https://pay.subfi.com":"https://pay-sandbox.subfi.com"}/payment_intents`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Account-Id":e,...!n?.Authorization&&{"X-Api-Key":i},"X-Render-Token":s,...n},body:JSON.stringify({payment_intent:o})});if(t.ok)return t.json();throw new Error(t.statusText)}p(b,"createPaymentIntent");async function l({token:o,requestBody:n,headers:e,env:i}){const{Authorization:s,...a}=e??{},t=await fetch(`${i==="production"?"https://pay.subfi.com":"https://pay-sandbox.subfi.com"}/embed/payment_methods`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Embed ${o}`,...a},body:JSON.stringify({payment_method:n})});if(t.ok)return t.json();throw new Error(t.statusText)}p(l,"createPaymentMethod");async function w({token:o,paymentIntentId:n,paymentMethodId:e,headers:i,env:s}){const{Authorization:a,...t}=i??{},c=await fetch(`${s==="production"?"https://pay.subfi.com":"https://pay-sandbox.subfi.com"}/embed/payment_intents/${n}/add_payment_method`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Embed ${o}`,...t},body:JSON.stringify({payment_intent:{payment_method_id:e}})});if(!c.ok)throw new Error(c.statusText)}p(w,"addPaymentMethodToPaymentIntent");async function A({token:o,paymentIntentId:n,headers:e,env:i}){const{Authorization:s,...a}=e??{},t=await fetch(`${i==="production"?"https://pay.subfi.com":"https://pay-sandbox.subfi.com"}/embed/payment_intents/${n}/confirm`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Embed ${o}`,...a}});if(t.ok)return t.json();throw new Error(t.statusText)}p(A,"confirmPaymentIntent");function u(o){const[n="",e="",i=""]=o.split("."),s=typeof atob=="function"?atob:a=>Buffer.from(a,"base64").toString("utf8");return{header:JSON.parse(s(n)),payload:JSON.parse(s(e)),signature:i}}p(u,"decodeJwt");exports.createClient=f;
