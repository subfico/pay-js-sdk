"use strict";var y=Object.defineProperty;var p=(o,n)=>y(o,"name",{value:n,configurable:!0});Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});function f({renderToken:o,apiKey:n}){const{env:a="sandbox"}=u(o).payload;async function s({accountId:i,data:e,headers:t}){const c="id"in e.customer?e.customer:await h({requestBody:e.customer,headers:t,apiKey:n,env:a}),r=(await b({requestBody:{...e.paymentIntent,amount:e.paymentIntent?.amount??0,...c?.id&&{customer_id:c.id}},headers:t,apiKey:n,env:a,accountId:i,renderToken:o})).token??"",d=await w({token:r,requestBody:{...e.paymentMethod,...c?.id&&{customer_id:c.id}},headers:t,env:a}),m=u(r).payload.payment_intent_id??"";return await l({token:r,paymentIntentId:m,paymentMethodId:d.id,headers:t,env:a}),await $({token:r,paymentIntentId:m,headers:t,env:a})}return p(s,"createPayment"),{createPayment:s}}p(f,"createClient");async function h({requestBody:o,headers:n,apiKey:a,env:s}){const i=await fetch(`${s==="production"?"https://pay.subfi.com":"https://pay-sandbox.subfi.com"}/customers`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...!n?.Authorization&&{"X-Api-Key":a},...n},body:JSON.stringify({customer:o})});if(i.ok)return i.json();if(i.status===422&&o?.email){const e=await fetch(`${s==="production"?"https://pay.subfi.com":"https://pay-sandbox.subfi.com"}/customers?email=${o.email}`,{headers:{"Content-Type":"application/json",Accept:"application/json",...!n?.Authorization&&{"X-Api-Key":a},...n}});if(e.ok){const t=(await e.json()).data[0];if(o?.metadata&&Object.keys(o.metadata).length>0){const c=await fetch(`${s==="production"?"https://pay.subfi.com":"https://pay-sandbox.subfi.com"}/customers/${t.id}`,{method:"PATCH",headers:{"Content-Type":"application/json",Accept:"application/json",...!n?.Authorization&&{"X-Api-Key":a},...n},body:JSON.stringify({customer:{metadata:{...t.metadata,...o.metadata}}})});if(c.ok)return c.json();throw new Error(`${c.statusText}: ${await c.text()}`)}return t}throw new Error(`${e.statusText}: ${await e.text()}`)}throw new Error(`${i.statusText}: ${await i.text()}`)}p(h,"findOrCreateCustomer");async function b({requestBody:o,headers:n,accountId:a,apiKey:s,renderToken:i,env:e}){const t=await fetch(`${e==="production"?"https://pay.subfi.com":"https://pay-sandbox.subfi.com"}/payment_intents`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Account-Id":a,...!n?.Authorization&&{"X-Api-Key":s},"X-Render-Token":i,...n},body:JSON.stringify({payment_intent:o})});if(t.ok)return t.json();throw new Error(`${t.statusText}: ${await t.text()}`)}p(b,"createPaymentIntent");async function w({token:o,requestBody:n,headers:a,env:s}){const{Authorization:i,...e}=a??{},t=await fetch(`${s==="production"?"https://pay.subfi.com":"https://pay-sandbox.subfi.com"}/embed/payment_methods`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Embed ${o}`,...e},body:JSON.stringify({payment_method:n})});if(t.ok)return t.json();throw new Error(`${t.statusText}: ${await t.text()}`)}p(w,"createPaymentMethod");async function l({token:o,paymentIntentId:n,paymentMethodId:a,headers:s,env:i}){const{Authorization:e,...t}=s??{},c=await fetch(`${i==="production"?"https://pay.subfi.com":"https://pay-sandbox.subfi.com"}/embed/payment_intents/${n}/add_payment_method`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Embed ${o}`,...t},body:JSON.stringify({payment_intent:{payment_method_id:a}})});if(!c.ok)throw new Error(`${c.statusText}: ${await c.text()}`)}p(l,"addPaymentMethodToPaymentIntent");async function $({token:o,paymentIntentId:n,headers:a,env:s}){const{Authorization:i,...e}=a??{},t=await fetch(`${s==="production"?"https://pay.subfi.com":"https://pay-sandbox.subfi.com"}/embed/payment_intents/${n}/confirm`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Embed ${o}`,...e}});if(t.ok)return t.json();throw new Error(`${t.statusText}: ${await t.text()}`)}p($,"confirmPaymentIntent");function u(o){const[n="",a="",s=""]=o.split("."),i=typeof atob=="function"?atob:e=>Buffer.from(e,"base64").toString("utf8");return{header:JSON.parse(i(n)),payload:JSON.parse(i(a)),signature:s}}p(u,"decodeJwt");exports.createClient=f;
