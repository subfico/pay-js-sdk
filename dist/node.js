"use strict";var f=Object.defineProperty;var r=(o,n)=>f(o,"name",{value:n,configurable:!0});Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});function h({renderToken:o,apiKey:n}){const{env:a="sandbox"}=d(o).payload;async function s({accountId:i,data:e,headers:t,mockPaymentIntent:c}){if(c)return c;const p="id"in e.customer?e.customer:await b({requestBody:e.customer,headers:t,apiKey:n,env:a}),m=(await w({requestBody:{...e.paymentIntent,amount:e.paymentIntent?.amount??0,...p?.id&&{customer_id:p.id}},headers:t,apiKey:n,env:a,accountId:i,renderToken:o})).token??"",y=await l({token:m,requestBody:{...e.paymentMethod,...p?.id&&{customer_id:p.id}},headers:t,env:a}),u=d(m).payload.payment_intent_id??"";return await $({token:m,paymentIntentId:u,paymentMethodId:y.id,headers:t,env:a}),await x({token:m,paymentIntentId:u,headers:t,env:a})}return r(s,"createPayment"),{createPayment:s}}r(h,"createClient");async function b({requestBody:o,headers:n,apiKey:a,env:s}){const i=await fetch(`${s==="production"?"https://pay.subfi.com":"https://pay-sandbox.subfi.com"}/customers`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...!n?.Authorization&&{"X-Api-Key":a},...n},body:JSON.stringify({customer:o})});if(i.ok)return i.json();if(i.status===422&&o?.email){const e=await fetch(`${s==="production"?"https://pay.subfi.com":"https://pay-sandbox.subfi.com"}/customers?email=${o.email}`,{headers:{"Content-Type":"application/json",Accept:"application/json",...!n?.Authorization&&{"X-Api-Key":a},...n}});if(e.ok){const t=(await e.json()).data[0];if(o?.metadata&&Object.keys(o.metadata).length>0){const c=await fetch(`${s==="production"?"https://pay.subfi.com":"https://pay-sandbox.subfi.com"}/customers/${t.id}`,{method:"PATCH",headers:{"Content-Type":"application/json",Accept:"application/json",...!n?.Authorization&&{"X-Api-Key":a},...n},body:JSON.stringify({customer:{metadata:{...t.metadata,...o.metadata}}})});if(c.ok)return c.json();throw new Error(`${c.statusText}: ${await c.text()}`)}return t}throw new Error(`${e.statusText}: ${await e.text()}`)}throw new Error(`${i.statusText}: ${await i.text()}`)}r(b,"findOrCreateCustomer");async function w({requestBody:o,headers:n,accountId:a,apiKey:s,renderToken:i,env:e}){const t=await fetch(`${e==="production"?"https://pay.subfi.com":"https://pay-sandbox.subfi.com"}/payment_intents`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Account-Id":a,...!n?.Authorization&&{"X-Api-Key":s},"X-Render-Token":i,...n},body:JSON.stringify({payment_intent:o})});if(t.ok)return t.json();throw new Error(`${t.statusText}: ${await t.text()}`)}r(w,"createPaymentIntent");async function l({token:o,requestBody:n,headers:a,env:s}){const{Authorization:i,...e}=a??{},t=await fetch(`${s==="production"?"https://pay.subfi.com":"https://pay-sandbox.subfi.com"}/embed/payment_methods`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Embed ${o}`,...e},body:JSON.stringify({payment_method:n})});if(t.ok)return t.json();throw new Error(`${t.statusText}: ${await t.text()}`)}r(l,"createPaymentMethod");async function $({token:o,paymentIntentId:n,paymentMethodId:a,headers:s,env:i}){const{Authorization:e,...t}=s??{},c=await fetch(`${i==="production"?"https://pay.subfi.com":"https://pay-sandbox.subfi.com"}/embed/payment_intents/${n}/add_payment_method`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Embed ${o}`,...t},body:JSON.stringify({payment_intent:{payment_method_id:a}})});if(!c.ok)throw new Error(`${c.statusText}: ${await c.text()}`)}r($,"addPaymentMethodToPaymentIntent");async function x({token:o,paymentIntentId:n,headers:a,env:s}){const{Authorization:i,...e}=a??{},t=await fetch(`${s==="production"?"https://pay.subfi.com":"https://pay-sandbox.subfi.com"}/embed/payment_intents/${n}/confirm`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Embed ${o}`,...e}});if(t.ok)return t.json();throw new Error(`${t.statusText}: ${await t.text()}`)}r(x,"confirmPaymentIntent");function d(o){const[n="",a="",s=""]=o.split("."),i=typeof atob=="function"?atob:e=>Buffer.from(e,"base64").toString("utf8");return{header:JSON.parse(i(n)),payload:JSON.parse(i(a)),signature:s}}r(d,"decodeJwt");exports.createClient=h;
